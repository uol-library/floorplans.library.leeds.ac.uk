function a(e){if(canUseLocalStorage())try{var t=window[e],o="__storage_test__";return t.setItem(o,o),t.removeItem(o),1}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}function t(e){var t=localStorage.getItem(e);return t?(t=JSON.parse(t),(new Date).getTime()>t.expiry?(localStorage.removeItem(e),null):t.value):null}function l(r){var e;r.hasOwnProperty("key")&&r.hasOwnProperty("url")&&(r.hasOwnProperty("expires")||(r.expires=24),a("localStorage")&&t(r.key)?(n("getting data '"+r.key+"' from local storage","utilities.js"),r.hasOwnProperty("callback")&&"function"==typeof r.callback&&r.callback(JSON.parse(t(r.key)))):(n("getting data '"+r.key+"' from "+r.url,"utilities.js"),(e=new XMLHttpRequest).addEventListener("load",function(){var e,t,o;a("localStorage")&&(e=(new Date).getTime()+60*r.expires*60*1e3,n("storing data '"+r.key+"' in localstorage - expires "+e,"utilities.js"),e=r.key,t=this.responseText,o=r.expires,t={value:t,expiry:(new Date).getTime()+60*o*60*1e3},localStorage.setItem(e,JSON.stringify(t))),r.hasOwnProperty("callback")&&"function"==typeof r.callback&&r.callback(JSON.parse(this.responseText))}),e.open("GET",r.url),e.send()))}function n(e,t){var o;floorplans.conf.debug&&(o=new Date,console.log(o.getHours()+":"+o.getMinutes().toString().padStart(2,"0")+":"+o.getSeconds().toString().padStart(2,"0")+"."+o.getMilliseconds().toString().padStart(3,"0")+" "+t.padEnd(12)+" - "+e))}"use strict";var e,o;function r(e,t,o){var r,a,l,n;t=t||1;for(var s=0;s<e[0].length;s++){var i=e[0][s];(!s||i[0]<r)&&(r=i[0]),(!s||i[1]<a)&&(a=i[1]),(!s||i[0]>l)&&(l=i[0]),(!s||i[1]>n)&&(n=i[1])}var c=l-r,f=n-a,d=Math.min(c,f),p=d/2;if(0===d)return(y=[r,a]).distance=0,y;for(var u=new Queue(void 0,w),h=r;h<l;h+=d)for(var m=a;m<n;m+=d)u.push(new x(h+p,m+p,p,e));for(var g=D(e),y=new x(r+c/2,a+f/2,0,e),b=(y.d>g.d&&(g=y),u.length);u.length;){var v=u.pop();v.d>g.d&&(g=v,o)&&console.log("found best %f after %d probes",Math.round(1e4*v.d)/1e4,b),v.max-g.d<=t||(p=v.h/2,u.push(new x(v.x-p,v.y-p,p,e)),u.push(new x(v.x+p,v.y-p,p,e)),u.push(new x(v.x-p,v.y+p,p,e)),u.push(new x(v.x+p,v.y+p,p,e)),b+=4)}o&&(console.log("num probes: "+b),console.log("best distance: "+g.d));c=[g.y,g.x];return c.distance=g.d,c}function w(e,t){return t.max-e.max}function x(e,t,o,r){this.x=e,this.y=t,this.h=o,this.d=i(e,t,r),this.max=this.d+this.h*Math.SQRT2}function i(e,t,o){for(var r=!1,a=1/0,l=0;l<o.length;l++)for(var n=o[l],s=0,i=n.length,c=i-1;s<i;c=s++){var f=n[s],d=n[c];f[1]>t!=d[1]>t&&e<(d[0]-f[0])*(t-f[1])/(d[1]-f[1])+f[0]&&(r=!r),a=Math.min(a,p(e,t,f,d))}return 0===a?0:(r?1:-1)*Math.sqrt(a)}function D(e){for(var t=0,o=0,r=0,a=e[0],l=0,n=a.length,s=n-1;l<n;s=l++){var i=a[l],c=a[s],f=i[0]*c[1]-c[0]*i[1];o+=(i[0]+c[0])*f,r+=(i[1]+c[1])*f,t+=3*f}return 0===t?new x(a[0][0],a[0][1],0,e):new x(o/t,r/t,0,e)}function p(e,t,o,r){var a,l=o[0],o=o[1],n=r[0]-l,s=r[1]-o;return 0==n&&0==s||(1<(a=((e-l)*n+(t-o)*s)/(n*n+s*s))?(l=r[0],o=r[1]):0<a&&(l+=n*a,o+=s*a)),(n=e-l)*n+(s=t-o)*s}e=this,o=function(){function r(e,t){return e<t?-1:t<e?1:0}function e(e,t){if(void 0===t&&(t=r),this.data=e=void 0===e?[]:e,this.length=this.data.length,this.compare=t,0<this.length)for(var o=(this.length>>1)-1;0<=o;o--)this._down(o)}return e.prototype.push=function(e){this.data.push(e),this.length++,this._up(this.length-1)},e.prototype.pop=function(){var e;if(0!==this.length)return e=this.data[0],this.length--,0<this.length&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),e},e.prototype.peek=function(){return this.data[0]},e.prototype._up=function(e){for(var t=this.data,o=this.compare,r=t[e];0<e;){var a=e-1>>1,l=t[a];if(0<=o(r,l))break;t[e]=l,e=a}t[e]=r},e.prototype._down=function(e){for(var t=this.data,o=this.compare,r=this.length>>1,a=t[e];e<r;){var l=1+(e<<1),n=l+1,s=t[l];if(n<this.length&&o(t[n],s)<0&&(s=t[l=n]),0<=o(s,a))break;t[e]=s,e=l}t[e]=a},e},"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):e.Queue=o(),canUseLocalStorage=function(){return!1},document.addEventListener("DOMContentLoaded",function(){floorplans.map=new L.Map("floorplan",{crs:L.CRS.Simple,zoom:floorplans.imgconf.startZoom,center:[floorplans.imgconf.startLat,floorplans.imgconf.startLng],minZoom:floorplans.imgconf.minZoom,maxZoom:floorplans.imgconf.maxZoom,zoomControl:!1}),L.control.zoom({position:"topright"}).addTo(floorplans.map),floorplans.imagelayers.forEach(e=>{e.floors.forEach(e=>{floorplans.maxHeight=Math.max(floorplans.maxHeight,e.height),floorplans.maxWidth=Math.max(floorplans.maxWidth,e.width)})}),floorplans.mapBounds=new L.LatLngBounds(floorplans.map.unproject([0,floorplans.maxHeight],floorplans.imgconf.maxZoom),floorplans.map.unproject([floorplans.maxWidth,0],floorplans.imgconf.maxZoom)),floorplans.conf.debug&&floorplans.map.on("click",function(e){console.log(e.latlng.lng+", "+e.latlng.lat)}),k(),f()});var c=function(r){return r.floorlayer?new Promise((e,t)=>{n("addFloorLayer - floor layer already present for "+r,"core.js"),e(r.floorlayer)}):new Promise((o,e)=>{var t=new Image;r.imageBounds=L.latLngBounds(floorplans.map.unproject([0,0],floorplans.imgconf.maxZoom),floorplans.map.unproject([r.width,r.height],floorplans.imgconf.maxZoom)),t.onload=function(){n("addFloorLayer - image loaded for "+r.floorname,"core.js");var e=L.imageOverlay(r.imageurl,r.imageBounds);let t=L.layerGroup([e]);l({url:r.dataurl,key:r.floorid,callback:function(e){r.selecters={shelf:[],location:[]},n("addFloorLayer - GeoJSON loaded for "+r.floorname,"core.js"),r.features=L.geoJSON(e,{onEachFeature:function(e,t){"shelf"==e.properties.type?(t.id="shelf"+e.id,r.selecters.shelf.push({value:t.id,label:e.properties.name,class:e.properties.class})):"location"==e.properties.type&&(t.id="location"+e.id,r.selecters.location.push({value:t.id,label:e.properties.name,class:e.properties.class})),t.bindPopup(e.properties.name,{className:"feature-tooltip"}),t.on({mouseover:h,focus:h})},style:function(e){let t=.5;return{weight:0,opacity:0,fillOpacity:t="location"==e.properties.type?0:t,className:e.properties.class}}}),t.addLayer(r.features),n("Added shelf features for "+r.floorname,"refactor.js"),r.floorlayer=t,o(t)}})},t.src=r.imageurl})};function f(){let o=m(),r=!1;o.floorid&&floorplans.imagelayers.forEach(e=>{e.floors.forEach(t=>{t.floorid===o.floorid&&(r=!0,c(t).then(e=>{A(t),U(t),e.addTo(floorplans.map),floorplans.map.fitBounds(t.imageBounds),floorplans.map.setView(t.imageBounds.getCenter()),d(o.floorid),u(t,o.shelfname),floorplans.imagelayers.forEach(e=>{e.floors.forEach(e=>{c(e)})})}))})}),r||floorplans.imagelayers.forEach(e=>{e.floors.forEach(e=>{c(e)})})}function d(e){var t=document.getElementById("floorselecter");if(t)for(var o=0;o<t.options.length;o++)t.options[o].value===e&&(t.options[o].selected=!0)}function u(e,t){e.selecters.shelf.forEach(e=>{e.label.match(t)&&_(e.value)})}function h(e){var t=e.target;t.id&&"shelf"==t.feature.properties.type?t.setStyle({fillOpacity:.75}):t.id&&"location"==t.feature.properties.type&&t.setStyle({fillOpacity:.4}),e.latlng?t.openPopup(e.latlng):t.openPopup(r(t.feature.geometry.coordinates))}function m(){var t={library:!1,floorid:!1,shelfid:!1,shelfname:!1,classmark:!1,search:!1,path:!1};if(window.location.search){var o,r=new URLSearchParams(window.location.search);t.search=r.toString();let e=!1;r.has("path")&&(o=r.get("path").split("/"),(t.path=o).length&&"floorplan"===o[0]?r.has("library")&&(t.library=g(r.get("library")),t.library)&&("health-sciences"===t.library?t.floorid="health-sciences":r.has("floor")&&(t.floorid=y(r.get("floor")),e=t.floorid.split("-").pop())):2<=o.length&&"floors"===o[1]&&(t.library=o[0],3<=o.length)&&(e=o[2],"brotherton"===t.library?-1!==["m1","m2","m3","m4","w2","w3"].indexOf(e)&&(t.floorid=t.library+"-"+e):"edwardboyle"===t.library?8<=parseInt(e)&&parseInt(e)<=13&&(t.floorid=t.library+"-"+e):"healthsciences"===t.library?t.floorid="health-sciences":"laidlaw"===t.library&&-1!==["ground","first","second","third"].indexOf(e)&&(t.floorid=t.library+"-"+e))),r.has("classmark")&&(t.classmark=E(r.get("classmark"),t),o=b(t.library,e,t.classmark))&&(t.floorid||(t.floorid=o.floorid),t.shelfid=o.featureid,t.shelfname=o.name)}return t}function g(e){var t={LL:"laidlaw",BL:"brotherton",EBL:"edwardboyle",HSL:"health-sciences"};return!!t.hasOwnProperty(e)&&t[e]}function y(e){var t={llhdc:"laidlaw-ground",ll1:"laidlaw-first",ll2:"laidlaw-second",ll3:"laidlaw-third",blmic:"brotherton-m1",blm1:"brotherton-m1",blm2:"brotherton-m2",blm3:"brotherton-m3",blm4:"brotherton-m4",blw2:"brotherton-w2",blw2a:"brotherton-w2",blw3:"brotherton-w3",ebl8:"edwardboyle-8",ebl9:"edwardboyle-9",ebl10:"edwardboyle-10",ebl11:"edwardboyle-11",ebl12:"edwardboyle-12",ebl13:"edwardboyle-13"};return!!t.hasOwnProperty(e)&&t[e]}function b(t,o,r){var a=getFeatures();let l=!1;for(let e=0;e<a.length;e++){var n=S(t,o);if(a[e][1].match(n)){n=v(a[e][0]);if(r.match(n)){n=a[e][1].split("-");l={name:a[e][0],library:n[0],floorid:n[0]+"-"+n[1],featureid:"shelf-"+n[2]};break}}}return l}function v(e){return"^"+(e=-1!==(e=e.replaceAll("/([|])/","")).indexOf(", ")?"("+e.split(", ").join("|")+")":e)+".*$"}function S(e,t){return t?"^"+e+"-"+t+".*$":"^"+e+".*$"}function E(e,t){if((e=decodeURIComponent(e)).match("^Video"))return"DVD";if(e.match("Atlas Case"))return"Atlases";if(e.match("([a-zA-Z ]+) A-0.01"))return e.match("([a-zA-Z ]+) A-0.01")[1]+" Journals";if(t.floorid)switch(t.floorid){case"brotherton-w2":if(e.match("Large .*")||e.match("Newspapers"))return"All Large Journals & Foreign Newspapers";if(e.match("Stack Large"))return"All Stack Large A-Z";break;case"brotherton-w3":if(e.match(" A-0.01"))return"Current Periodicals";break;case"health-sciences":if(e.match("Pamphlet"))return"Pamphlets"}return e}function k(){floorplans.controlsContainer=L.DomUtil.get("floorplan-controls");var e=L.DomUtil.create("fieldset","floorplans-selecter",floorplans.controlsContainer),e=(L.DomUtil.create("legend","floorplans-selecter-header",e).textContent="Library Floorplans",floorplans.controls=L.DomUtil.create("div","floorplans-selecter-content",e),floorplans.controls.setAttribute("id","floorplans-selecter-controls"),L.DomUtil.create("label","selecter__label",floorplans.controls));e.textContent="Select a Library / floor",e.setAttribute("id","floorselecterlabel"),e.setAttribute("for","floorselecter");let t=L.DomUtil.create("select","selecter__select",e);t.setAttribute("id","floorselecter");L.DomUtil.create("option","",t).textContent="Select a Library / floor",floorplans.imagelayers.forEach(e=>{let o=L.DomUtil.create("optgroup","",t);o.setAttribute("label",e.title),e.floors.forEach(e=>{var t=L.DomUtil.create("option","",o);t.textContent=e.floorname,t.setAttribute("value",e.floorid)})});e=L.DomUtil.create("div","hidden",floorplans.controls);e.setAttribute("id","shelfselecter"),L.DomUtil.create("h3","",e).textContent="Subjects on this floor";L.DomUtil.create("ul","selecter__list",e).setAttribute("id","shelfselecterlist");e=L.DomUtil.create("div","hidden",floorplans.controls);e.setAttribute("id","locationselecter"),L.DomUtil.create("h3","",e).textContent="Also on this floor";L.DomUtil.create("ul","selecter__list",e).setAttribute("id","locationselecterlist"),L.DomEvent.on(t,"change",function(){""!==this.options[this.selectedIndex].value&&(floorplans.map.eachLayer(function(e){floorplans.map.removeLayer(e)}),["shelfselecter","locationselecter"].forEach(e=>{L.DomUtil.empty(L.DomUtil.get(e+"list")),L.DomUtil.addClass(L.DomUtil.get(e),"hidden")}),floorplans.imagelayers.forEach(e=>{e.floors.forEach(t=>{t.floorid==this.options[this.selectedIndex].value&&c(t).then(e=>{A(t),U(t),e.addTo(floorplans.map),floorplans.map.fitBounds(t.imageBounds),floorplans.map.setView(t.imageBounds.getCenter()),n("Added layer for floor "+t.floorname,"refactor.js")})})}))});var o=document.getElementById("menu-close-button"),r=document.getElementById("floorplan-controls");o.addEventListener("click",e=>{o.classList.contains("close")?(o.classList.remove("close"),r.classList.add("closed")):(o.classList.add("close"),r.classList.remove("closed"))})}function A(e){for(s in e.selecters){var t=L.DomUtil.get(s+"selecter");let o=L.DomUtil.get(s+"selecterlist");e.selecters[s].length&&(e.selecters[s].forEach(e=>{var t=L.DomUtil.create("li",e.class+" item-"+s,o),t=(t.setAttribute("data-sortkey",e.label.toLowerCase().replace(/\W/g,"")),L.DomUtil.create("button","shelfbutton",t));t.innerText=e.label,t.setAttribute("data-featureid",e.value),L.DomEvent.on(t,"focus mouseover",function(e){O(e.target.getAttribute("data-featureid")).fire("mouseover",{},!0)}),L.DomEvent.on(t,"blur mouseout",function(e){O(e.target.getAttribute("data-featureid")).fire("mouseout",{},!0)})}),L.DomUtil.removeClass(t,"hidden"))}}function U(e){for(s in e.selecters){let t=L.DomUtil.get(s+"selecterlist"),o=[];t.querySelectorAll("li").forEach(e=>{o.push(e.getAttribute("data-sortkey"))}),o.sort(),o.forEach(e=>{e=t.querySelector('[data-sortkey="'+e+'"]');t.appendChild(e)})}}function O(t){let o=!1;return floorplans.map.eachLayer(e=>{e.id&&e.id===t&&(o=e)}),o}function _(e){var t=O(e);!1!==t&&(t.fire("mouseover",{},!0),t=document.querySelector('button[data-featureid="'+e+'"]'))&&t.focus()}