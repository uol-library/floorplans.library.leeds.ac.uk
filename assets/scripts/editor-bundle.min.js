function n(t){let o=!1;return floorplans.map.eachLayer(e=>{e.id&&e.id===t&&(o=e)}),o}function a(e){if(canUseLocalStorage())try{var t=window[e],o="__storage_test__";return t.setItem(o,o),t.removeItem(o),1}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}function t(e){var t=localStorage.getItem(e);return t?(t=JSON.parse(t),(new Date).getTime()>t.expiry?(localStorage.removeItem(e),null):t.value):null}function l(r){var e;r.hasOwnProperty("key")&&r.hasOwnProperty("url")&&(r.hasOwnProperty("expires")||(r.expires=24),a("localStorage")&&t(r.key)?(i("getting data '"+r.key+"' from local storage"),r.hasOwnProperty("callback")&&"function"==typeof r.callback&&r.callback(JSON.parse(t(r.key)))):(i("getting data '"+r.key+"' from "+r.url),(e=new XMLHttpRequest).addEventListener("load",function(){var e,t,o;a("localStorage")&&(e=(new Date).getTime()+60*r.expires*60*1e3,i("storing data '"+r.key+"' in localstorage - expires "+e),e=r.key,t=this.responseText,o=r.expires,t={value:t,expiry:(new Date).getTime()+60*o*60*1e3},localStorage.setItem(e,JSON.stringify(t))),r.hasOwnProperty("callback")&&"function"==typeof r.callback&&r.callback(JSON.parse(this.responseText))}),e.open("GET",r.url),e.send()))}function i(e){var t;floorplans.conf.debug&&(t=new Date,console.log(t.getHours()+":"+t.getMinutes().toString().padStart(2,"0")+":"+t.getSeconds().toString().padStart(2,"0")+"."+t.getMilliseconds().toString().padStart(3,"0")+" "+e))}"use strict";var e,o;e=this,o=function(){function r(e,t){return e<t?-1:t<e?1:0}function e(e,t){if(void 0===t&&(t=r),this.data=e=void 0===e?[]:e,this.length=this.data.length,this.compare=t,0<this.length)for(var o=(this.length>>1)-1;0<=o;o--)this._down(o)}return e.prototype.push=function(e){this.data.push(e),this.length++,this._up(this.length-1)},e.prototype.pop=function(){var e;if(0!==this.length)return e=this.data[0],this.length--,0<this.length&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),e},e.prototype.peek=function(){return this.data[0]},e.prototype._up=function(e){for(var t=this.data,o=this.compare,r=t[e];0<e;){var a=e-1>>1,l=t[a];if(0<=o(r,l))break;t[e]=l,e=a}t[e]=r},e.prototype._down=function(e){for(var t=this.data,o=this.compare,r=this.length>>1,a=t[e];e<r;){var l=1+(e<<1),n=l+1,s=t[l];if(n<this.length&&o(t[n],s)<0&&(s=t[l=n]),0<=o(s,a))break;t[e]=s,e=l}t[e]=a},e},"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):e.Queue=o(),canUseLocalStorage=function(){return!1},document.addEventListener("DOMContentLoaded",function(){floorplans.map=new L.Map("floorplan",{crs:L.CRS.Simple,zoom:floorplans.imgconf.startZoom,center:[floorplans.imgconf.startLat,floorplans.imgconf.startLng],minZoom:floorplans.imgconf.minZoom,maxZoom:floorplans.imgconf.maxZoom,zoomControl:!1}),floorplans.map.attributionControl.setPrefix('<a href="https://leafletjs.com" target="external" title="A JavaScript library for interactive maps" aria-label="Leaflet - a JavaScript library for interactive maps"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8"><path fill="#4C7BE1" d="M0 0h12v4H0z"></path><path fill="#FFD500" d="M0 4h12v3H0z"></path><path fill="#E0BC00" d="M0 7h12v1H0z"></path></svg> Leaflet</a>'),L.control.zoom({position:"topright"}).addTo(floorplans.map),floorplans.imagelayers.forEach(e=>{e.floors.forEach(e=>{floorplans.maxHeight=Math.max(floorplans.maxHeight,e.height),floorplans.maxWidth=Math.max(floorplans.maxWidth,e.width)})}),floorplans.mapBounds=new L.LatLngBounds(floorplans.map.unproject([0,floorplans.maxHeight],floorplans.imgconf.maxZoom),floorplans.map.unproject([floorplans.maxWidth,0],floorplans.imgconf.maxZoom)),floorplans.conf.debug&&floorplans.map.on("click",function(e){console.log(e.latlng.lng+", "+e.latlng.lat)}),L.Control.FloorSelecter=L.Control.extend({onAdd:function(e){var t=L.DomUtil.create("div","floorplan-controls");let r=L.DomUtil.create("select","selecter__select",t);r.setAttribute("id","floorselecter");var o=L.DomUtil.create("button","export__button",t);return o.setAttribute("id","exportbutton"),o.textContent="Export",L.DomUtil.create("option","",r).textContent="Select a Library / floor",floorplans.imagelayers.forEach(e=>{let o=L.DomUtil.create("optgroup","",r);o.setAttribute("label",e.title),e.floors.forEach(e=>{var t=L.DomUtil.create("option","",o);t.textContent=e.floorname,t.setAttribute("value",e.floorid)})}),t},onRemove:function(e){}}),L.control.floorselecter=function(e){return new L.Control.FloorSelecter(e)},L.control.floorselecter({position:"topleft"}).addTo(floorplans.map),L.DomEvent.on(floorselecter,"change",function(){""!==this.options[this.selectedIndex].value&&(floorplans.map.eachLayer(function(e){floorplans.map.removeLayer(e)}),floorplans.imagelayers.forEach(e=>{e.floors.forEach(t=>{t.floorid==this.options[this.selectedIndex].value&&c(t).then(e=>{e.addTo(floorplans.map),floorplans.map.fitBounds(t.imageBounds),floorplans.map.setView(t.imageBounds.getCenter()),i("Added layer for floor "+t.floorname)})})}))}),L.DomEvent.on(L.DomUtil.get("exportbutton"),"click",function(){let t=L.DomUtil.create("div","exchange-overlay",L.DomUtil.get("maincontainer"));var e=L.DomUtil.create("button","btn-menu close",t);e.setAttribute("id","menu-close-button"),L.DomUtil.create("span","icon",e),L.DomUtil.create("span","visuallyhidden",e).textContent="Close",e.addEventListener("click",e=>{L.DomUtil.remove(t)}),L.DomUtil.create("textarea","geojson-container",t).textContent=JSON.stringify(floorplans.map.pm.getGeomanLayers(!0).toGeoJSON(),null,4),L.DomUtil.toFront(t)}),floorplans.map.pm.addControls(),floorplans.map.pm.setGlobalOptions({snappable:!1}),document.dispatchEvent(new Event("fpmapready"))});var c=function(r){return r.floorlayer?new Promise((e,t)=>{i("addFloorLayer - floor layer already present for "+r),e(r.floorlayer)}):new Promise((o,e)=>{var t=new Image;r.imageBounds=L.latLngBounds(floorplans.map.unproject([0,0],floorplans.imgconf.maxZoom),floorplans.map.unproject([r.width,r.height],floorplans.imgconf.maxZoom)),t.onload=function(){i("addFloorLayer - image loaded for "+r.floorname);var e=L.imageOverlay(r.imageurl,r.imageBounds);let t=L.layerGroup([e]);l({url:r.dataurl,key:r.floorid,callback:function(e){r.selecters={shelf:[],location:[]},i("addFloorLayer - GeoJSON loaded for "+r.floorname),r.features=L.geoJSON(e,{onEachFeature:function(e,t){"shelf"==e.properties.type?(t.id="shelf"+e.id,r.selecters.shelf.push({value:t.id,label:e.properties.name,class:e.properties.class})):"location"==e.properties.type&&(t.id="location"+e.id,r.selecters.location.push({value:t.id,label:e.properties.name,class:e.properties.class})),t.bindPopup(e.properties.name,{className:"feature-tooltip"}),t.on({click:p,popupclose:f})},style:function(e){let t=.5;return{weight:0,opacity:0,fillOpacity:t="location"==e.properties.type?0:t,className:e.properties.class}}}),r.features.options.pmIgnore=!1,t.addLayer(r.features),i("Added shelf features for "+r.floorname),r.floorlayer=t,o(t)}})},t.src=r.imageurl})};function p(e){e=e.target;e.options.pmIgnore=!1,L.PM.reInitLayer(e)}function f(e){floorplans.map.eachLayer(e=>{e.options.pmIgnore=!0})}import{DomEvent as d,DomUtil as u}from"leaflet";import{fplog as i}from"./utilities.mjs";function r(){let r=new u;var e=new d;floorplans.controlsContainer=r.get("floorplan-controls");r.create("h2","floorplans-selecter-header",floorplans.controlsContainer).textContent="Library Floorplans Navigation";var t=r.create("fieldset","floorplans-selecter",floorplans.controlsContainer),t=(r.create("legend","floorplans-selecter-legend visuallyhidden",t).textContent="Floorplan controls",floorplans.controls=r.create("div","floorplans-selecter-content",t),floorplans.controls.setAttribute("id","floorplans-selecter-controls"),r.create("label","selecter__label",floorplans.controls));t.textContent="Select a Library / floor",t.setAttribute("id","floorselecterlabel"),t.setAttribute("for","floorselecter");let a=r.create("select","selecter__select",floorplans.controls);a.setAttribute("id","floorselecter");r.create("option","",a).textContent="Select a Library / floor",floorplans.imagelayers.forEach(e=>{let o=r.create("optgroup","",a);o.setAttribute("label",e.title),e.floors.forEach(e=>{var t=r.create("option","",o);t.textContent=e.floorname,t.setAttribute("value",e.floorid)})});t=r.create("div","hidden",floorplans.controls);t.setAttribute("id","areaselecter"),r.create("h3","",t).textContent="Study Areas";r.create("ul","selecter__list",t).setAttribute("id","areaselecterlist");t=r.create("div","hidden",floorplans.controls);t.setAttribute("id","shelfselecter"),r.create("h3","",t).textContent="Subjects on this floor";r.create("ul","selecter__list",t).setAttribute("id","shelfselecterlist");t=r.create("div","hidden",floorplans.controls);t.setAttribute("id","locationselecter"),r.create("h3","",t).textContent="Also on this floor";r.create("ul","selecter__list",t).setAttribute("id","locationselecterlist"),e.on(a,"change",function(){""!==this.options[this.selectedIndex].value&&(floorplans.map.eachLayer(function(e){floorplans.map.removeLayer(e)}),["areaselecter","shelfselecter","locationselecter"].forEach(e=>{var t=r.get(e+"list");t&&t.hasChildNodes()&&r.empty(t),r.addClass(r.get(e),"hidden")}),floorplans.imagelayers.forEach(e=>{e.floors.forEach(t=>{t.floorid==this.options[this.selectedIndex].value&&c(t).then(e=>{m(t),h(t),e.addTo(floorplans.map),floorplans.currentFloor=t,floorplans.map.fitBounds(t.imageBounds),floorplans.map.setView(t.imageBounds.getCenter()),i("Added layer for floor "+t.floorname)})})}))});var o=document.getElementById("menu-close-button"),l=document.getElementById("floorplan-controls");o.addEventListener("click",e=>{o.classList.contains("close")?(o.classList.remove("close"),l.classList.add("closed")):(o.classList.add("close"),l.classList.remove("closed"))})}function m(e){let a=new u,l=new d;for(s in e.selecters){var t=a.get(s+"selecter");let r=a.get(s+"selecterlist");e.selecters[s].length&&(e.selecters[s].forEach(e=>{var t=a.create("li","item-"+s,r);t.setAttribute("data-sortkey",e.label.toLowerCase().replace(/\W/g,"").replace(/(8|13)([1-9])$/,"$10$2"));let o=s+"button "+e.class;e.icon&&""!==e.icon&&(o+=" icon-"+e.icon);t=a.create("button",o,t);t.innerText=e.label,t.setAttribute("data-featureid",e.value),l.on(t,"focus mouseover",function(e){n(e.target.getAttribute("data-featureid")).fire("mouseover",{},!0)}),l.on(t,"blur mouseout",function(e){n(e.target.getAttribute("data-featureid")).fire("mouseout",{},!0)}),e.desc&&""!==e.desc&&!e.icon&&(t.title=e.desc)}),a.removeClass(t,"hidden"))}}function h(e){var r=new u;for(s in e.selecters){let t=r.get(s+"selecterlist"),o=[];t.querySelectorAll("li").forEach(e=>{o.push(e.getAttribute("data-sortkey"))}),o.sort(),o.forEach(e=>{e=t.querySelector('[data-sortkey="'+e+'"]');t.appendChild(e)})}}export{m as buildFeatureSelects,h as sortFeatureSelects,r as setupSelecterControl};